(async function(){const API='/api';const listEl=document.getElementById('list');const searchEl=document.getElementById('search');const newBtn=document.getElementById('newBtn');const titleEl=document.getElementById('title');const slugEl=document.getElementById('slug');const icd10El=document.getElementById('icd10');const snomedEl=document.getElementById('snomed');const bodyEl=document.getElementById('body');const varsEl=document.getElementById('vars');const linksEl=document.getElementById('links');const addVarBtn=document.getElementById('addVar');const addLinkBtn=document.getElementById('addLink');const saveBtn=document.getElementById('save');const submitBtn=document.getElementById('submit');const publishBtn=document.getElementById('publish');const statusEl=document.getElementById('status');let active=null,items=[];async function loadList(q){const url=q?API+`/studio/templates?q=${encodeURIComponent(q)}`:API+'/studio/templates';const r=await fetch(url);items=await r.json();listEl.innerHTML='';items.forEach(it=>{const li=document.createElement('li');li.textContent=`${it.title} — ${it.status} v${it.version}`;li.style.cursor='pointer';li.onclick=async()=>{const rr=await fetch(API+`/studio/templates/${it.slug}`);active=await rr.json();renderEditor();};listEl.appendChild(li);});}function renderEditor(){if(!active)return;titleEl.value=active.title||'';slugEl.value=active.slug||'';icd10El.value=active.diagnosis_icd10||'';snomedEl.value=active.diagnosis_snomed||'';bodyEl.value=active.body_md||'';if(!active.variables)active.variables=[];if(!active.links)active.links=[];renderVars();renderLinks();statusEl.textContent=`Status: ${active.status} · Version: ${active.version}`;}function renderVars(){varsEl.innerHTML='';(active.variables||[]).forEach((v,i)=>{const row=document.createElement('div');row.className='row';row.style.gridTemplateColumns='1fr 1fr 120px 1fr';row.innerHTML=`<input placeholder='key' value='${v.key||''}' data-idx='${i}' data-field='key' /><input placeholder='label' value='${v.label||''}' data-idx='${i}' data-field='label' /><label class='small'><input type='checkbox' ${v.required?'checked':''} data-idx='${i}' data-field='required' /> required</label><input placeholder='default' value='${v.defaultValue||''}' data-idx='${i}' data-field='defaultValue' />`;varsEl.appendChild(row);row.querySelectorAll('input').forEach(inp=>{inp.addEventListener('input',(e)=>{const idx=parseInt(e.target.dataset.idx,10);const f=e.target.dataset.field;const isCheck=e.target.type==='checkbox';active.variables[idx][f]=isCheck?e.target.checked:e.target.value;});});});}function renderLinks(){linksEl.innerHTML='';(active.links||[]).forEach((l,i)=>{const row=document.createElement('div');row.className='row';row.innerHTML=`<input placeholder='Title' value='${l.title||''}' data-idx='${i}' data-field='title' /><input placeholder='URL' value='${l.url||''}' data-idx='${i}' data-field='url' />`;linksEl.appendChild(row);row.querySelectorAll('input').forEach(inp=>{inp.addEventListener('input',(e)=>{const idx=parseInt(e.target.dataset.idx,10);const f=e.target.dataset.field;active.links[idx][f]=e.target.value;});});}addVarBtn.onclick=()=>{if(!active)active={title:'',slug:'',body_md:'',variables:[],links:[]};active.variables.push({key:'',label:'',required:false,defaultValue:''});renderVars();};addLinkBtn.onclick=()=>{if(!active)active={title:'',slug:'',body_md:'',variables:[],links:[]};active.links.push({title:'',url:''});renderLinks();};newBtn.onclick=()=>{active={title:'New Template',slug:'',body_md:'',variables:[],links:[],tags:[]};renderEditor();};saveBtn.onclick=async()=>{if(!active)return;const payload={slug:slugEl.value,title:titleEl.value,diagnosis_icd10:icd10El.value||null,diagnosis_snomed:snomedEl.value||null,tags:[],body_md:bodyEl.value,variables:(active.variables||[]),links:(active.links||[]),change_note:'Edited in Studio',org_id:null};const method=active.id?'PUT':'POST';const url=active.id?(API+`/studio/templates/${active.slug}`):(API+'/studio/templates');const r=await fetch(url,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});const data=await r.json();active=data;await loadList(searchEl.value);renderEditor();statusEl.textContent='Saved.';};submitBtn.onclick=async()=>{if(!active)return;const r=await fetch(API+`/studio/templates/${active.slug}/submit`,{method:'POST'});active=await r.json();statusEl.textContent='Submitted.';renderEditor();loadList(searchEl.value);};publishBtn.onclick=async()=>{if(!active)return;const r=await fetch(API+`/studio/templates/${active.slug}/publish`,{method:'POST'});active=await r.json();statusEl.textContent='Published.';renderEditor();loadList(searchEl.value);};searchEl.addEventListener('input',()=>loadList(searchEl.value));loadList();})();