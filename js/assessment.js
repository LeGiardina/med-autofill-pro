(function(){const API='/api';const micBtn=document.getElementById('micBtn');const extractBtn=document.getElementById('extractBtn');const transcriptEl=document.getElementById('transcript');const dxCard=document.getElementById('dxCard');const dxList=document.getElementById('dxList');const insertBtn=document.getElementById('insertTemplatesBtn');const guidelineLinks=document.getElementById('guideline-links');let listening=false,recognition=null,extracted=null;function initMic(){const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){return;}recognition=new SR();recognition.continuous=true;recognition.interimResults=true;recognition.onresult=(e)=>{let t='';for(let i=e.resultIndex;i<e.results.length;i++){t+=e.results[i][0].transcript;}transcriptEl.value=t;extractBtn.disabled=t.trim().length===0;};}micBtn.addEventListener('click',()=>{if(!recognition){initMic();}if(!recognition){alert('Speech recognition not supported in this browser.');return;}if(!listening){listening=true;micBtn.textContent='Stop Mic';recognition.start();}else{listening=false;micBtn.textContent='Start Mic';try{recognition.stop();}catch(e){}}});transcriptEl.addEventListener('input',()=>{extractBtn.disabled=transcriptEl.value.trim().length===0;});extractBtn.addEventListener('click',async()=>{const r=await fetch(API+'/extract_assessment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({transcript:transcriptEl.value})});extracted=await r.json();if(extracted&&extracted.mapping){extracted.mapping.forEach(m=>{try{const el=document.querySelector(m.target_path);if(!el)return;const val=m.key.split('.').reduce((acc,k)=>{if(k.endsWith(']')){const base=k.substring(0,k.indexOf('['));const idx=parseInt(k.substring(k.indexOf('[')+1,k.indexOf(']')),10);return acc&&acc[base]?acc[base][idx]:undefined;}return acc?acc[k]:undefined;},extracted);if(val!==undefined&&val!==null){el.value=String(val);}}catch(e){}});}dxList.innerHTML='';(extracted.assessment||[]).forEach(dx=>{const li=document.createElement('li');li.textContent=dx.label+(dx.icd10?` (${dx.icd10})`:'')+(dx.status?` — ${dx.status}`:'');dxList.appendChild(li);});dxCard.style.display=(extracted.assessment&&extracted.assessment.length)?'block':'none';});insertBtn.addEventListener('click',async()=>{if(!extracted)return;const confirmed=(extracted.assessment||[]).filter(d=>d.status==='confirmed');const useList=confirmed.length?confirmed:extracted.assessment;const r=await fetch(API+'/render_template',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({diagnoses:useList,context:extracted})});const data=await r.json();const plan=document.getElementById('plan');plan.value=(plan.value?plan.value+'\n\n':'')+(data.html||'').replace(/<[^>]+>/g,'');if(Array.isArray(data.links)){guidelineLinks.innerHTML=data.links.map(l=>`<a href="${l.url}" target="_blank" rel="noopener noreferrer">${l.title}</a>`).join(' · ');}});})();